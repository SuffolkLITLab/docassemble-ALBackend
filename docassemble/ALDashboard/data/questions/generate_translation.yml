---
include:
  - nav.yml
---
modules:
  - .translation
---
metadata:
  title: |
    Translation support tool    
---
mandatory: True
code: |
  the_yaml_path
  if not the_task.ready():
    waiting_screen
  show_translation_results
---
# code: |
#   translations = [
#     translation_file(the_yaml_path, tr_lang, use_gpt=use_gpt)
#     for tr_lang
#     in tr_langs.split()
#   ]
---
code: |
  the_task = background_action('translate_file')
---
event: waiting_screen
question: |
  Please wait while we translate your file
subquestion: |
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Processing...</span>
  </div>
reload: True
---
event: translate_file
code: |
  translations = [
    translation_file(the_yaml_path, tr_lang, use_gpt=use_gpt)
    for tr_lang
    in tr_langs.split()
  ]
  background_response_action('save_translations', translations=translations)
---
event: save_translations
code: |
  translations = action_argument('translations')
  background_response()
---
question: |
  What file do you want to translate?
fields:
  - "YAML file path (like: docassemble.AssemblyLine:assembly_line.yml)": the_yaml_path
    datatype: combobox
    code: |
      [
        {form["filename"]: form["title"] }
        for form in interview_menu()
      ]
  - "Language codes (like: es, one per line)": tr_langs
    datatype: area
  - Include a draft translation with GPT or Google Translate: use_gpt
    datatype: yesno
    show if:
      code: |
        gpt_is_available() # or google_translate_is_available()
  - note: |
      To use OpenAI's GPT-3, you need to set up an OpenAI account and get an API key.
    show if:
      code: |
        not gpt_is_available()

---
event: show_translation_results
question: |
  Translation results
subquestion: |
  % for index, tr_lang in enumerate(tr_langs.split()):
  ## ${ tr_lang }
  ${ translations[index].file }

  Number of words to translate: ${ translations[index].untranslated_words }

  Number of untranslated rows: ${ translations[index].untranslated_segments }

  Percentage of rows that are not translated: %${ translations[index].untranslated_segments/translations[index].total_rows * 100 }
  % endfor